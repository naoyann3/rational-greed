<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes"> <!-- ズーム許可に修正 -->
<title>Rational Greed v5.0 - Strategic Asset Simulator</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #0f172a; -webkit-tap-highlight-color: transparent; }
  .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); padding: 20px; border: 1px solid #e2e8f0; }
  
  .ranking-scroll::-webkit-scrollbar { width: 4px; }
  .ranking-scroll::-webkit-scrollbar-track { background: transparent; }
  .ranking-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

  .asset-checkbox:checked + div { background-color: #f1f5f9; border-color: currentColor; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }
  
  .warning { background-color: #fee2e2; border-left: 4px solid #ef4444; padding: 12px; margin: 12px 0; border-radius: 8px; }
  .error { background-color: #fee2e2; padding: 8px; border-radius: 4px; }
</style>
</head>
<body class="p-4">

<div class="max-w-4xl mx-auto space-y-6">

  <!-- 戦略モード選択 -->
  <div class="card">
    <h2 class="text-lg font-bold mb-4">戦略モード選択 (v5.0)</h2>
    <select id="strategyMode" class="w-full p-2 border rounded mb-4">
      <option value="deepseek">DeepSeek守り (Cash重視)</option>
      <option value="grok">Grok攻め (需給重視)</option>
      <option value="gemini">Geminiバランス</option>
      <option value="custom" selected>カスタム (v5.0推奨)</option>
    </select>
    <label><input type="checkbox" id="demandNews"> 需給ニュースあり (Silver/NVIDIA需給爆発)</label>
  </div>

  <!-- ポートフォリオ入力 -->
  <div class="card">
    <h2 class="text-lg font-bold mb-4">ポートフォリオ配分 (%)</h2>
    <div class="grid grid-cols-2 gap-4">
      <div><label>NVDA/AVGO</label><input type="number" id="nvda" value="20" class="w-full p-2 border rounded"></div>
      <div><label>Silver</label><input type="number" id="silver" value="10" class="w-full p-2 border rounded"></div>
      <div><label>BTC</label><input type="number" id="btc" value="15" class="w-full p-2 border rounded"></div>
      <div><label>Cash</label><input type="number" id="cash" value="35" class="w-full p-2 border rounded"></div>
      <div><label>Defense/Software</label><input type="number" id="defense" value="20" class="w-full p-2 border rounded"></div>
    </div>
    <button onclick="updatePortfolio()" class="mt-4 bg-indigo-600 text-white px-4 py-2 rounded">更新</button>
  </div>

  <!-- 過熱警告 -->
  <div id="overheatWarning" class="warning hidden">
    <strong>警告：</strong> RSI > 70の過熱資産あり。FOMO注意。待機推奨。
  </div>

  <!-- エラー表示 -->
  <div id="errorMessage" class="error hidden"></div>

  <!-- シミュレーション結果 -->
  <div class="card">
    <h2 class="text-lg font-bold mb-4">2026年シミュレーション結果</h2>
    <canvas id="performanceChart" height="400"></canvas>
  </div>

</div>

<script>
// 初期ポートフォリオ
let portfolio = {
  nvda: 20,
  silver: 10,
  btc: 15,
  cash: 35,
  defense: 20
};

// チャートインスタンス
let myChart;

// モード別固定配分
const modes = {
  deepseek: { nvda: 15, silver: 5, btc: 15, cash: 45, defense: 20 },
  grok: { nvda: 35, silver: 20, btc: 15, cash: 20, defense: 10 },
  gemini: { nvda: 25, silver: 15, btc: 15, cash: 30, defense: 15 },
  custom: null // 入力値使用
};

// APIキー（実際は自分のキーに置き換え）
const API_KEY = 'YOUR_ALPHA_VANTAGE_API_KEY'; // 無料取得: https://www.alphavantage.co/support/#api-key

// RSI取得関数
async function fetchRSI(symbol) {
  try {
    const response = await fetch(`https://www.alphavantage.co/query?function=RSI&symbol=${symbol}&interval=daily&time_period=14&apikey=${API_KEY}`);
    const data = await response.json();
    const rsiData = data['Technical Analysis: RSI'];
    const latestDate = Object.keys(rsiData)[0];
    return parseFloat(rsiData[latestDate]['RSI']);
  } catch (error) {
    console.error('API Error:', error);
    return 0; // エラー時は0として扱う
  }
}

// ポートフォリオ更新
async function updatePortfolio() {
  // モード選択
  const mode = document.getElementById('strategyMode').value;
  if (modes[mode]) {
    Object.assign(portfolio, modes[mode]);
  } else {
    portfolio.nvda = Number(document.getElementById('nvda').value);
    portfolio.silver = Number(document.getElementById('silver').value);
    portfolio.btc = Number(document.getElementById('btc').value);
    portfolio.cash = Number(document.getElementById('cash').value);
    portfolio.defense = Number(document.getElementById('defense').value);
  }

  const sum = portfolio.nvda + portfolio.silver + portfolio.btc + portfolio.cash + portfolio.defense;
  if (sum !== 100) {
    document.getElementById('errorMessage').textContent = `配分合計が100%ではありません: ${sum}%`;
    document.getElementById('errorMessage').classList.remove('hidden');
    return;
  } else {
    document.getElementById('errorMessage').classList.add('hidden');
  }

  // 需給ニュースONでSilver/NVIDIAアップ
  if (document.getElementById('demandNews').checked) {
    portfolio.silver = Math.min(20, portfolio.silver + 5);
    portfolio.nvda = Math.min(30, portfolio.nvda + 5);
    portfolio.cash = 100 - (portfolio.nvda + portfolio.silver + portfolio.btc + portfolio.defense);
  }

  // 過熱警告 (API連携)
  const rsiSilver = await fetchRSI('SLV'); // Silver ETF
  if (rsiSilver > 70) {
    document.getElementById('overheatWarning').classList.remove('hidden');
  } else {
    document.getElementById('overheatWarning').classList.add('hidden');
  }

  // チャート更新（ダミーデータ例、実際はシミュレーション関数に置き換え）
  updateChart();
}

// チャート更新 (ダミー)
function updateChart() {
  const ctx = document.getElementById('performanceChart').getContext('2d');
  if (myChart) myChart.destroy();
  myChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
      datasets: [{
        label: 'Portfolio Performance',
        data: [5, 10, 8, 15, 12, 20, 18, 25, 22, 30, 28, 35], // ダミー: 実際はシミュ計算
        borderColor: '#6366f1',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: { y: { ticks: { callback: v => v + '%' } } }
    }
  });
}

// 初期化
window.onload = async () => {
  updatePortfolio();
};
</script>
</body>
</html>
