<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Rational Greed v5.1 - The Command Center</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #0f172a; }
  .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); padding: 20px; border: 1px solid #e2e8f0; }
  .asset-checkbox:checked + div { background-color: #f1f5f9; border-color: currentColor; box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); }
  .period-btn { transition: all 0.2s; }
  .period-btn.active { background-color: #0f172a; color: white; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3); }
  /* „Çπ„ÇØ„É≠„Éº„É´„Éê„ÉºÈùûË°®Á§∫ */
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  
  /* RSI„Ç∑„Ç∞„Éä„É´„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
  @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
  .signal-buy { animation: pulse-green 2s infinite; border-color: #10b981; color: #047857; background-color: #ecfdf5; }
  .signal-sell { border-color: #f43f5e; color: #be123c; background-color: #fff1f2; }
  
  /* „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÁµêÊûú„Ç´„Éº„Éâ */
  .simulation-result-card { transition: all 0.3s ease; border-left: 4px solid transparent; }
  .simulation-result-card:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05); }
</style>
</head>
<body class="p-3 md:p-8 max-w-[1600px] mx-auto bg-slate-50 pb-20">

  <!-- ‚òÖ„É™„Ç¢„É´„Çø„Ç§„É†„Éª„Éû„Éº„Ç±„ÉÉ„Éà„Éê„Éº -->
  <div class="bg-slate-900 text-white py-3 px-4 flex justify-between items-center sticky top-0 z-50 shadow-md rounded-b-lg mb-6">
    <div class="flex items-center gap-6 overflow-x-auto whitespace-nowrap scrollbar-hide w-full mr-4" id="ticker-area">
      <span class="text-slate-400 font-mono text-xs shrink-0">MARKET DATA:</span>
      <span class="text-slate-500 text-sm">Ready to fetch...</span>
    </div>
    <button onclick="fetchRealtimeData()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded font-bold transition flex items-center gap-1 shrink-0 text-xs">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
      Êõ¥Êñ∞
    </button>
  </div>

  <!-- Êà¶Áï•„Éù„Éº„Éà„Éï„Ç©„É™„Ç™ -->
  <div class="card mb-6 p-4 bg-indigo-50 border-l-4 border-indigo-600 text-slate-900 shadow-sm">
    <div class="flex justify-between items-start mb-4">
      <h3 class="text-sm font-bold flex items-center">
        <span class="mr-2 text-indigo-900">üìä 2026 Target Portfolio</span>
        <span class="text-[10px] bg-indigo-200 px-2 py-0.5 rounded text-indigo-800 font-extrabold">Rational Greed v5.1</span>
      </h3>
      <div class="text-[10px] text-slate-500 bg-white px-2 py-1 rounded border border-slate-200 font-medium">Êà¶Áï•: ÂæÖÊ©ü„ÅßÊ©ü‰ºö„ÇíË≤∑„ÅÑ„ÄÅÈúÄÁµ¶„ÅßÂà©Áõä„ÇíÂèñ„Çã</div>
    </div>
    <div class="flex flex-col md:flex-row items-center gap-8">
      <div class="w-40 h-40 relative shrink-0"><canvas id="portfolioChart"></canvas></div>
      <div class="flex-1 w-full grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2 text-sm">
        <div class="flex justify-between items-center border-b border-indigo-200/50 pb-1"><span class="text-slate-600 font-medium">Cash (ÂÜÜ/„Éâ„É´)</span><span class="font-bold text-emerald-600">35%</span></div>
        <div class="flex justify-between items-center border-b border-indigo-200/50 pb-1"><span class="text-slate-600 font-medium">AI Core (H+S)</span><span class="font-bold text-indigo-600">20%</span></div>
        <div class="flex justify-between items-center border-b border-indigo-200/50 pb-1"><span class="text-slate-600 font-medium">AI„Çµ„ÉÜ„É©„Ç§„Éà (Def)</span><span class="font-bold text-cyan-600">20%</span></div>
        <div class="flex justify-between items-center border-b border-indigo-200/50 pb-1"><span class="text-slate-600 font-medium">Bitcoin (BTC)</span><span class="font-bold text-orange-600">15%</span></div>
        <div class="flex justify-between items-center border-b border-indigo-200/50 pb-1"><span class="text-slate-600 font-medium">Silver (ÈäÄ)</span><span class="font-bold text-slate-500">10%</span></div>
      </div>
    </div>
  </div>

  <!-- „É°„Ç§„É≥„Ç®„É™„Ç¢ -->
  <div class="flex flex-col lg:grid lg:grid-cols-4 gap-6">
    
    <!-- „ÉÅ„É£„Éº„Éà & „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ -->
    <div class="lg:col-span-3 order-1 space-y-6">
      <div class="card h-[55vh] md:h-[650px] relative p-1 md:p-6 w-full">
        <canvas id="chart"></canvas>
      </div>
      
      <!-- Summary Cards -->
      <div class="grid grid-cols-3 gap-2 md:gap-4 text-center">
        <div class="card bg-gradient-to-br from-indigo-50 to-white py-4 px-2">
          <div class="text-[10px] text-indigo-400 font-bold uppercase mb-1">Top</div>
          <div id="summary-best-name" class="text-xs md:text-sm font-black text-indigo-900 truncate">-</div>
          <div id="summary-best-val" class="text-xs font-bold text-indigo-600">-</div>
        </div>
        <div class="card bg-white py-4 px-2 flex flex-col justify-center">
          <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Avg Change</div>
          <div id="summary-avg" class="text-sm md:text-lg font-black text-slate-700">-</div>
        </div>
        <div class="card bg-white py-4 px-2 text-right">
          <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Bottom</div>
          <div id="summary-worst-name" class="text-xs md:text-sm font-black text-slate-700 truncate">-</div>
          <div id="summary-worst-val" class="text-xs font-bold text-slate-500">-</div>
        </div>
      </div>

      <!-- ‚òÖ RSI„Ç≥„ÉÉ„ÇØ„Éî„ÉÉ„Éà (ÁèæÂú®‰æ°Ê†º„Ç´„É©„É†ËøΩÂä†) -->
      <div class="card">
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center">
          <span class="bg-slate-200 text-slate-700 px-2 py-1 rounded mr-2">RADAR</span> Êà¶Ê≥ÅÁõ£Ë¶ñ„Ç≥„ÉÉ„ÇØ„Éî„ÉÉ„Éà
        </h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm text-left text-slate-600">
            <thead class="text-xs text-slate-400 uppercase bg-slate-50">
              <tr>
                <th class="p-3 w-20">ÈäòÊüÑ</th>
                <th class="p-3 w-24">ÁèæÂú®‰æ°Ê†º</th> <!-- New Column -->
                <th class="p-3 w-24">ÁõÆÊ®ô‰æ°Ê†º</th>
                <th class="p-3 w-24">Ë∑ùÈõ¢</th>
                <th class="p-3 w-32">RSI (Êó•Ë∂≥)</th>
                <th class="p-3">Âà§ÂÆö</th>
              </tr>
            </thead>
            <tbody id="rsi-table-body" class="divide-y divide-slate-100">
              <!-- JS„ÅßÁîüÊàê -->
            </tbody>
          </table>
        </div>
        <p class="text-[10px] text-slate-400 mt-2 text-right">‚ÄªRSI < 35: Ë≤∑„ÅÑÂ†¥ (Grok) / RSI > 70: ÈÅéÁÜ± (DeepSeek)</p>
      </div>

      <!-- Á©çÁ´ã„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ -->
      <div class="card">
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4"><span class="bg-emerald-100 text-emerald-800 px-2 py-1 rounded mr-2">SIM</span> Á©çÁ´ã„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ (Ë©≥Á¥∞Áâà)</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <input type="number" id="monthly-amount" value="20000" class="w-full px-4 py-2 border rounded text-sm">
          <select id="start-year" class="w-full px-4 py-2 border rounded text-sm"><option value="2021" selected>2021Âπ¥</option><option value="2022">2022Âπ¥</option><option value="2023">2023Âπ¥</option><option value="2024">2024Âπ¥</option><option value="2025">2025Âπ¥</option></select>
          <select id="start-month" class="w-full px-4 py-2 border rounded text-sm"><option value="01">1Êúà</option><option value="04">4Êúà</option><option value="07">7Êúà</option><option value="10">10Êúà</option></select>
          <button id="simulate-btn" class="bg-indigo-600 text-white font-bold py-2 rounded text-sm hover:bg-indigo-700 transition">ÂÆüË°å</button>
        </div>
        <div id="simulation-results" class="space-y-4">
             <div class="text-center py-6 text-slate-400 text-sm">Ë®≠ÂÆö„ÇíÂÖ•Âäõ„Åó„Å¶„ÄåÂÆüË°å„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        </div>
      </div>

      <!-- ‚òÖ ÂèÇË¨Ä„Éé„Éº„Éà (Local Storage) -->
      <div class="card bg-slate-50 border-slate-200">
        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 flex justify-between">
          <span>üìù ÂèÇË¨Ä„Éé„Éº„Éà (‰∏âË≥¢ËÄÖ„ÅÆÂä©Ë®Ä)</span>
          <span id="save-status" class="text-[10px] text-emerald-500 hidden">Saved!</span>
        </h3>
        <textarea id="memo-pad" class="w-full h-32 p-3 text-sm border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="„Åì„Åì„Å´Grok„ÅÆÂóÖË¶ö„ÇÑDeepSeek„ÅÆË≠¶Âëä„ÇíË®òÈå≤„Åõ„Çà..."></textarea>
      </div>
    </div>

    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <div class="lg:col-span-1 space-y-6 order-2">
      <div class="card p-4">
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Ë°®Á§∫ÈäòÊüÑ</h3>
        <div class="grid grid-cols-1 gap-1" id="asset-toggles"></div>
      </div>
      <div class="card h-[400px] flex flex-col">
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">È®∞ËêΩÁéá„É©„É≥„Ç≠„É≥„Ç∞</h3>
        
        <!-- ÊúüÈñìÈÅ∏Êäû„Éú„Çø„É≥ („Éï„É´„Çª„ÉÉ„Éà) -->
        <div class="flex flex-wrap gap-2 mb-2 justify-center">
            <button class="period-btn active px-3 py-1 rounded border border-slate-200 font-bold text-[10px]" data-period="all">ÂÖ®ÊúüÈñì</button>
            <button class="period-btn px-3 py-1 rounded border border-slate-200 font-bold text-[10px]" data-period="2021">2021</button>
            <button class="period-btn px-3 py-1 rounded border border-slate-200 font-bold text-[10px]" data-period="2022">2022</button>
            <button class="period-btn px-3 py-1 rounded border border-slate-200 font-bold text-[10px]" data-period="2023">2023</button>
            <button class="period-btn px-3 py-1 rounded border border-slate-200 font-bold text-[10px]" data-period="2024">2024</button>
            <button class="period-btn px-3 py-1 rounded border border-slate-200 font-bold text-[10px]" data-period="2025">2025</button>
        </div>

        <div class="flex-1 overflow-y-auto pr-1 space-y-1" id="ranking-list"></div>
      </div>
    </div>
  </div>

<script>
// --- CONFIGURATION ---
// Áõ£Ë¶ñÂØæË±°„Å®ÁõÆÊ®ô‰æ°Ê†º (Target Price)
const targets = {
  NVDA: 130, SMH: 220, AVGO: 160, PLTR: 60, CRWD: 300,
  BTC: 85000, SIL: 28, GLD: 250
};

// =========================================================
//  DATA DEFINITION (Real ÂÜÜÂª∫„Å¶ Data)
// =========================================================
const db = {
  ASML: [55915,60412,68098,70580,74238,76361,84088,91588,83404,92534,90076,91606,78055,76972,81501,73110,73641,64999,76531,67971,60002,69829,84373,71638,86226,84207,90671,86716,100989,104931,101416,105156,87928,89288,100539,106740,128184,143376,146870,136371,150730,164536,156139,132100,119022,127814,158615,108753,113925,106371,99140,95067,106124,115814,109945,107270,144464,163015,165519],
  TSM: [12720,13416,13046,12713,12898,13281,12791,13084,12497,12942,13332,13843,14134,12368,12722,12051,12177,11166,11788,11563,9902,9097,11513,9766,13599,11874,12390,11491,13782,14611,14207,14382,13978,12869,14308,14666,16646,19385,20589,21468,23706,27962,25312,25093,24787,29191,27652,31004,32255,27081,24836,23720,27845,32731,33816,33221,41501,46236,45519],
  NVDA: [1361,1460,1478,1649,1770,2211,2155,2452,2317,2824,3722,3383,2824,2832,3532,2414,2402,1929,2420,2026,1681,1860,2317,1683,2518,3244,3704,3852,5859,6588,6939,6078,5945,6443,7335,7281,9535,12440,13665,13636,16194,17143,15350,18364,18073,18683,18810,21124,18620,18943,16641,16204,21096,25227,30293,28646,31230,34800,31230],
  AMD: [8964, 9002, 8659, 8888, 8801, 10382, 11645, 12173, 11518, 13686, 18023, 16557, 13168, 14258, 13341, 11090, 13016, 10444, 12586, 11773, 9158, 8877, 10770, 8491, 9805, 10711, 13054, 12182, 15992, 16562, 16035, 15451, 15358, 14687, 17815, 20787, 24712, 28913, 27315, 24747, 26196, 26096, 25010, 21115, 23432, 22072, 20542, 18963, 17867, 14980, 15372, 13854, 15951, 20507, 31103, 23908, 24041, 39416, 33967],
  SMH: [11861,12834,13431,13232,13694,14382,14387,14887,14342,15574,17349,17766,15871,15509,16461,14904,13063,13919,15792,14131,13369,13984,15531,13304,15468,16317,17529,15533,18476,20353,22615,22822,21656,20719,23597,24660,27392,31931,34050,33465,37744,41941,37731,35564,35056,37026,36258,38020,37541,34918,31639,30420,38379,40303,43093,42137,48496,55869,55009],
  AVGO: [4716,5006,5115,4968,5191,5321,5323,5466,5428,5723,6301,7656,6753,6790,7684,7189,7413,6636,7134,6924,6413,6949,7645,7330,7633,8101,8545,8541,11295,12558,12648,13484,12406,12546,13611,15742,17389,19593,20058,20325,20851,25829,24533,23798,24630,26010,24271,36398,34097,29917,25050,27388,34969,39841,42468,43722,49023,56886,62922],
  PLTR: [3683,2546,2569,2509,2522,2914,2381,2896,2691,2946,2350,2095,1580,1370,1675,1349,1109,1239,1379,1071,1174,1299,1041,842,1015,1152,1125,1056,2056,2220,2793,2190,2390,2207,2948,2421,2371,3467,3482,3434,3405,4075,3867,4601,5312,6367,10041,11863,12711,12739,12239,11854,18982,19684,23629,23039,27106,30852,26303],
  CRWD: [22590,23010,20132,22708,24416,27779,27813,30894,27512,32078,24711,23559,20821,22565,22114,24203,20444,21808,24103,25464,26362,23828,23075,13805,13818,18711,18285,16365,22790,23405,20673,23395,25002,26351,34847,36005,43105,48301,48332,45729,49233,61648,35413,40525,40046,45482,51808,53717,61341,58454,73369,60292,65476,73604,73204,62292,72868,83569,79505],
  BTC: [3467557,4813675,6507676,6310030,4088027,3891489,4557750,5183873,4875342,6989294,6428337,5319007,4430489,4964484,5540012,4925250,4091192,2705066,3103425,2785170,2811424,3048933,2368041,2169712,3009478,3149604,3779598,3987163,3792091,4397975,4159102,3774683,4026381,5256500,5591733,5961862,6269113,9170140,10792036,9569960,10622342,10096447,9686116,8620933,9095437,10688597,14438361,14707594,14672003,12710027,12374921,13463700,15066900,15436001,17446478,15999985,16864269,16870246,14114830],
  ITA: [9324,10185,11463,11592,12123,12107,11841,11652,11668,11896,11164,11826,11657,12934,13519,13339,13056,13543,13831,14151,13171,15847,15530,14666,14962,15637,15685,15535,15190,16892,16577,16972,15829,16381,17624,17853,18075,19266,19966,20300,21349,21244,21860,21588,21367,22126,23296,22819,24128,23220,22906,22646,25531,27262,29338,29172,31095,33210,32026],
  SILVER: [2616,2627,2418,2615,2847,2677,2592,2434,2297,2515,2397,2475,2397,2615,2792,2729,2535,2495,2300,2528,2528,3044,2835,2887,2848,2620,3015,3135,3021,3025,3194,3271,3038,3128,3401,3071,3082,3123,3443,3760,4357,4275,4030,3851,4058,4567,4181,4134,4393,4247,4638,4212,4321,4742,4972,5380,6296,6773,7996],
  GOLD: [18069,17238,17042,18041,19605,18308,18622,18658,18383,18971,18835,19671,19374,20618,22047,22942,21870,22472,21857,22102,22340,22454,22867,22242,23409,23144,24976,25192,25487,25244,25670,26301,25610,27450,27754,26959,27772,28521,31134,33123,33792,34591,34591,33804,34707,38839,36776,38013,39843,39493,43110,43220,43730,44053,45209,47258,52821,56654,60567],
  SP500: [13641,14043,15142,15861,15975,16444,16777,17277,16951,18163,18432,19204,17837,17684,19683,18851,18669,18301,19236,19417,18548,20365,19380,18035,18524,19213,19167,19670,20875,22664,22984,23519,22940,22238,23926,24281,26026,27391,28559,28832,29510,31789,29851,29198,29562,32262,32695,34182,33955,31801,30280,28788,30919,32527,34608,34812,36175,38371,38984]
};

const meta = {
  ASML:   { label:'ASML (Ë£ÖÁΩÆ)', color:'#1e40af', type:'stock' },
  TSM:    { label:'TSM (Ë£ΩÈÄ†)', color:'#3b82f6', type:'stock' },
  NVDA:   { label:'NVDA (Ë®≠Ë®à)', color:'#84cc16', type:'stock' },
  AMD:    { label:'AMD (ÂØæÊäó)', color:'#ef4444', type:'stock' },
  SMH:    { label:'AI Semi (ETF)', color:'#4f46e5', type:'stock' },
  AVGO:   { label:'AI Infra (AVGO)', color:'#1e3a8a', type:'stock' },
  PLTR:   { label:'AI Data (PLTR)', color:'#a855f7', type:'stock' },
  CRWD:   { label:'AI Cyber (CRWD)', color:'#06b6d4', type:'stock' },
  BTC:    { label:'Bitcoin (BTC)', color:'#f97316', type:'crypto' },
  ITA:    { label:'Defense (ITA)', color:'#eab308', type:'stock' },
  GOLD:   { label:'Gold (GLD)', color:'#ca8a04', type:'commodity' },
  SILVER: { label:'Silver (ÈäÄ)', color:'#64748b', type:'commodity' },
  SP500:  { label:'S&P 500', color:'#cbd5e1', type:'index' }
};

const labels = [];
let startY = 2021, startM = 1;
for (let i = 0; i < 59; i++) {
  labels.push(`${startY}/${String(startM).padStart(2,'0')}`);
  startM++;
  if (startM > 12) { startM = 1; startY++; }
}

let myChart = null;
let currentPeriod = 'all';
let activeKeys = Object.keys(db).filter(k => k !== 'SP500'); 
let selectedAssetKey = null;
let currentPrices = {}; 

// --- FUNCTIONS ---
async function fetchRealtimeData() {
  const tickerArea = document.getElementById('ticker-area');
  tickerArea.innerHTML = '<span class="text-indigo-400 animate-pulse text-sm">Fetching data...</span>';
  
  // ‚òÖ„ÅÇ„Å™„Åü„ÅÆAPI„Ç≠„Éº
  const API_KEY = 'd56ohg9r01qkgd82vfigd56ohg9r01qkgd82vfj0'; 

  // Áõ£Ë¶ñÂØæË±°„É™„Çπ„Éà (Á±≥ÂõΩÊ†™ + ETF)
  const stocks = ['NVDA', 'SMH', 'AVGO', 'PLTR', 'CRWD', 'ITA', 'GLD', 'SLV'];
  let html = '';
  
  try {
    // 1. Á±≥ÂõΩÊ†™ & ETF (Finnhub)
    for (const symbol of stocks) {
      // Âøµ„ÅÆ„Åü„ÇÅ„ÄÅETF„ÇÇÂêå„Åò„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÅßÂèñÂæó
      const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`);
      const data = await response.json();
      
      // „Éá„Éº„Çø„ÅåÂèñ„Çå„ÅüÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫ & ‰øùÂ≠ò
      if(data.c) {
        currentPrices[symbol] = data.c; // ‰æ°Ê†º„Çí‰øùÂ≠ò („Åì„Åì„ÅåÈáçË¶ÅÔºÅ)
        const color = data.dp >= 0 ? 'text-emerald-400' : 'text-rose-400';
        const sign = data.dp >= 0 ? '+' : '';
        html += `<div class="flex items-center gap-1 mr-4 shrink-0"><span class="font-bold text-slate-300 text-sm">${symbol}</span><span class="font-mono text-white text-sm">$${data.c}</span><span class="font-mono text-[10px] ${color}">(${sign}${data.dp.toFixed(2)}%)</span></div>`;
      } else {
        console.warn(`Failed to fetch ${symbol}`);
      }
    }

    // 2. Bitcoin (CoinGecko)
    const btcRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd,jpy&include_24hr_change=true');
    const btcData = await btcRes.json();
    if(btcData.bitcoin) {
      currentPrices['BTC'] = btcData.bitcoin.usd; // ‰æ°Ê†º„Çí‰øùÂ≠ò
      const color = btcData.bitcoin.usd_24h_change >= 0 ? 'text-emerald-400' : 'text-rose-400';
      const sign = btcData.bitcoin.usd_24h_change >= 0 ? '+' : '';
      html += `<div class="flex items-center gap-1 mr-4 border-l border-slate-700 pl-4 shrink-0"><span class="font-bold text-orange-400 text-sm">BTC</span><span class="font-mono text-white text-sm">$${btcData.bitcoin.usd.toLocaleString()}</span><span class="font-mono text-[10px] ${color}">(${sign}${btcData.bitcoin.usd_24h_change.toFixed(2)}%)</span></div>`;
    }

    tickerArea.innerHTML = html;
    
    // „Ç≥„ÉÉ„ÇØ„Éî„ÉÉ„ÉàÂÜÖ„ÅÆ„Çø„Éº„Ç≤„ÉÉ„ÉàË®àÁÆó„ÇíÊõ¥Êñ∞
    updateRsiTable();

  } catch (e) {
    console.error(e);
    tickerArea.innerHTML = '<span class="text-rose-500 text-sm">API Error (Check Console)</span>';
  }
}

function updateRsiTable() {
  const tbody = document.getElementById('rsi-table-body');
  tbody.innerHTML = '';
  
  Object.keys(targets).forEach(key => {
    let distanceStr = '-';
    let currentP = currentPrices[key];
    let priceStr = '-';
    
    if(currentP) {
      priceStr = `$${currentP}`;
      const dist = ((currentP - targets[key]) / targets[key]) * 100;
      const color = dist > 0 ? 'text-rose-500' : 'text-emerald-500';
      distanceStr = `<span class="${color} font-bold">${dist > 0 ? '+' : ''}${dist.toFixed(1)}%</span>`;
    }

    const row = document.createElement('tr');
    row.className = "border-b border-slate-50 hover:bg-slate-50/50 transition";
    row.innerHTML = `
      <td class="p-3 font-bold text-slate-700">${key}</td>
      <td class="p-3 font-mono text-xs text-slate-600 font-bold">${priceStr}</td>
      <td class="p-3 font-mono text-xs text-slate-500">$${targets[key]}</td>
      <td class="p-3 font-mono text-xs">${distanceStr}</td>
      <td class="p-3">
        <input type="number" class="w-16 p-1 border rounded text-center text-sm" placeholder="-" oninput="checkRsi(this)">
      </td>
      <td class="p-3 text-xs font-bold text-slate-400 status-cell">-</td>
    `;
    tbody.appendChild(row);
  });
}

function checkRsi(input) {
  const val = Number(input.value);
  const cell = input.parentElement.nextElementSibling;
  
  if (val && val < 35) {
    cell.innerHTML = '<span class="px-2 py-1 rounded bg-emerald-100 text-emerald-600 signal-buy">üü¢ BUY</span>';
  } else if (val && val > 70) {
    cell.innerHTML = '<span class="px-2 py-1 rounded bg-rose-100 text-rose-600 signal-sell">üî¥ WAIT</span>';
  } else {
    cell.textContent = 'NEUTRAL';
  }
}

// ----------------------------------------
//  Memo Logic
// ----------------------------------------
const memoPad = document.getElementById('memo-pad');
const saveStatus = document.getElementById('save-status');

memoPad.value = localStorage.getItem('rational_greed_memo') || '';

memoPad.addEventListener('input', () => {
  localStorage.setItem('rational_greed_memo', memoPad.value);
  saveStatus.classList.remove('hidden');
  setTimeout(() => saveStatus.classList.add('hidden'), 2000);
});

// ----------------------------------------
//  Chart Logic
// ----------------------------------------
function initPortfolioChart() {
    new Chart(document.getElementById('portfolioChart'), {
      type: 'doughnut',
      data: {
        labels: ['Cash', 'AI Core', 'Defense', 'BTC', 'Silver'],
        datasets: [{ data: [35, 20, 20, 15, 10], backgroundColor: ['#10b981', '#4f46e5', '#06b6d4', '#f97316', '#64748b'], borderWidth: 0 }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '75%' }
    });
}

const customLabelPlugin = {
  id: 'customSmartLabels',
  afterDatasetsDraw: (chart) => {
    const { ctx, chartArea } = chart;
    const isMobile = window.innerWidth < 768;
    const labelPoints = [];
    chart.data.datasets.forEach((ds, i) => {
      const meta = chart.getDatasetMeta(i);
      if (meta.hidden) return;
      const lastPoint = meta.data[meta.data.length - 1];
      if (lastPoint && !isNaN(lastPoint.y)) {
        labelPoints.push({ y: lastPoint.y, label: ds.label, color: ds.borderColor });
      }
    });
    labelPoints.sort((a, b) => a.y - b.y);
    const labelHeight = isMobile ? 12 : 16;
    for (let i = 1; i < labelPoints.length; i++) {
      if (labelPoints[i].y < labelPoints[i-1].y + labelHeight) { labelPoints[i].y = labelPoints[i-1].y + labelHeight; }
    }
    ctx.save();
    ctx.font = `bold ${isMobile ? '8px' : '10px'} sans-serif`;
    labelPoints.forEach(p => { ctx.fillStyle = p.color; ctx.fillText(p.label, chartArea.right + 5, p.y); });
    ctx.restore();
  }
};

const negativeZonePlugin = {
  id: 'negativeZone',
  beforeDraw: (chart) => {
    const { ctx, chartArea, scales } = chart;
    const zeroPixel = scales.y.getPixelForValue(0);
    if (zeroPixel < chartArea.bottom) {
        ctx.save();
        ctx.fillStyle = 'rgba(220, 38, 38, 0.05)'; 
        ctx.fillRect(chartArea.left, zeroPixel, chartArea.width, chartArea.bottom - zeroPixel);
        ctx.restore();
    }
  }
};

function init() {
  initPortfolioChart();
  createAssetToggles();
  renderChart();
  setupSimulationListeners();
  updateDashboard();
  
  // ‚òÖ‰øÆÊ≠£Ôºö0.5ÁßíÂæÖ„Å£„Å¶„Åã„ÇâËá™ÂãïÂÆüË°å
  setTimeout(fetchRealtimeData, 500);
}

function createAssetToggles() {
  const container = document.getElementById('asset-toggles');
  Object.keys(meta).forEach(key => {
    const m = meta[key];
    const isChecked = activeKeys.includes(key) ? 'checked' : '';
    const div = document.createElement('div');
    div.innerHTML = `<label class="cursor-pointer block mb-1"><input type="checkbox" class="asset-checkbox hidden" value="${key}" ${isChecked}><div class="flex items-center p-1.5 rounded-lg border border-transparent transition-all hover:bg-white" style="color:${m.color}"><span class="w-2.5 h-2.5 rounded-full mr-2" style="background-color:${m.color}"></span><span class="font-bold text-[9px] text-slate-700">${m.label}</span></div></label>`;
    container.appendChild(div);
  });
  container.addEventListener('change', () => {
    activeKeys = Array.from(document.querySelectorAll('.asset-checkbox:checked')).map(c => c.value);
    updateDashboard('none');
  });
}

document.querySelectorAll('.period-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    currentPeriod = e.target.dataset.period;
    updateDashboard();
  });
});

function updateDashboard(mode = 'default') {
  const startIdx = (currentPeriod === 'all') ? 0 : labels.indexOf(`${currentPeriod}/01`);
  myChart.data.labels = labels.slice(startIdx);
  myChart.data.datasets = activeKeys.map(key => {
    const rawData = db[key].slice(startIdx);
    const base = rawData[0];
    return {
      label: meta[key].label,
      data: rawData.map(v => base ? ((v - base) / base) * 100 : 0),
      borderColor: meta[key].color,
      borderWidth: 2, pointRadius: 0, tension: 0.1
    };
  });
  myChart.update(mode);
  updateRanking(activeKeys, startIdx);
}

function updateRanking(keys, startIdx) {
  const performance = keys.map(key => {
    const data = db[key];
    const change = ((data[data.length-1] - data[startIdx]) / data[startIdx]) * 100;
    return { label: meta[key].label, color: meta[key].color, change };
  }).sort((a, b) => b.change - a.change);

  document.getElementById('ranking-list').innerHTML = performance.map(item => `
    <div class="ranking-item p-1.5 rounded flex justify-between items-center text-[9px]">
      <span class="font-bold" style="color:${item.color}">${item.label}</span>
      <span class="font-black ${item.change>=0?'text-emerald-500':'text-rose-500'}">${item.change.toFixed(1)}%</span>
    </div>`).join('');

  if(performance.length > 0) {
    document.getElementById('summary-best-name').textContent = performance[0].label;
    document.getElementById('summary-best-val').textContent = performance[0].change.toFixed(1) + '%';
    document.getElementById('summary-worst-name').textContent = performance[performance.length-1].label;
    document.getElementById('summary-worst-val').textContent = performance[performance.length-1].change.toFixed(1) + '%';
    const avg = performance.reduce((s, p) => s + p.change, 0) / performance.length;
    document.getElementById('summary-avg').textContent = avg.toFixed(1) + '%';
  }
}

function setupSimulationListeners() {
  document.getElementById('simulate-btn').addEventListener('click', () => {
    const amount = parseInt(document.getElementById('monthly-amount').value);
    const date = document.getElementById('start-year').value + '/' + document.getElementById('start-month').value;
    const startIdx = labels.indexOf(date);
    const results = activeKeys.map(key => {
      const data = db[key];
      if (startIdx === -1 || startIdx >= data.length) return null;
      let totalUnits = 0, totalInv = 0;
      for (let i = startIdx; i < data.length; i++) { totalUnits += amount / data[i]; totalInv += amount; }
      const curVal = totalUnits * data[data.length-1];
      return { label: meta[key].label, color: meta[key].color, totalInvestment: totalInv, currentValue: curVal, profitPerc: ((curVal - totalInv) / totalInv) * 100, totalUnits: totalUnits };
    }).filter(r => r).sort((a,b) => b.profitPerc - a.profitPerc);
    
    document.getElementById('simulation-results').innerHTML = results.map((r, index) => `
      <div class="simulation-result-card p-5 border border-slate-200 rounded-xl bg-white mb-4 ${r.profitPerc >= 0 ? 'border-l-emerald-500' : 'border-l-rose-500'}" style="border-left-color:${r.color}">
        <div class="flex items-start justify-between mb-4">
          <div class="flex items-center">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3" style="background-color:${r.color}">${index + 1}</div>
            <div>
              <div class="flex items-center">
                <span class="font-bold text-slate-900 text-lg">${r.label}</span>
                <span class="ml-2 text-xs font-medium px-2 py-1 rounded-full ${r.profitPerc >= 0 ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'}">${r.profitPerc.toFixed(1)}%</span>
              </div>
            </div>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-500">ÁèæÂú®‰æ°ÂÄ§</div>
            <div class="font-black text-xl text-slate-800">¬•${Math.floor(r.currentValue).toLocaleString()}</div>
          </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm mt-3 pt-3 border-t border-slate-100">
            <div>
                <div class="text-[10px] text-slate-400 uppercase tracking-wide">ÊäïË≥áÁ∑èÈ°ç</div>
                <div class="font-bold text-slate-700">¬•${r.totalInvestment.toLocaleString()}</div>
            </div>
            <div>
                <div class="text-[10px] text-slate-400 uppercase tracking-wide">ÊêçÁõäÈ°ç</div>
                <div class="font-bold ${r.profitPerc >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${r.profitPerc >= 0 ? '+' : ''}¬•${Math.floor(r.currentValue - r.totalInvestment).toLocaleString()}</div>
            </div>
            <div>
                <div class="text-[10px] text-slate-400 uppercase tracking-wide">ÂèñÂæóÂçò‰æ°ÁõÆÂÆâ</div>
                <div class="font-bold text-slate-700">¬•${Math.floor(r.totalInvestment / r.totalUnits).toLocaleString()}</div>
            </div>
        </div>
      </div>`).join('');
  });
}

function renderChart() {
  myChart = new Chart(document.getElementById('chart'), {
    type: 'line',
    data: { labels: [], datasets: [] },
    plugins: [customLabelPlugin, negativeZonePlugin],
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'nearest', axis: 'x', intersect: false },
      plugins: { legend: { display: false } },
      scales: { x: { grid: { display: false } }, y: { ticks: { callback: v => v + '%' } } },
      layout: { padding: { right: 120 } }
    }
  });
}

init();
</script>
</body>
</html>
